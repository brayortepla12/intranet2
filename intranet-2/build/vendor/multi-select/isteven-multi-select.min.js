"use strict";angular.module("isteven-multi-select",["ng"]).directive("istevenMultiSelect",["$sce","$timeout","$templateCache",function(e,t,r){return{restrict:"AE",scope:{inputModel:"=",outputModel:"=",isDisabled:"=",onClear:"&",onClose:"&",onSearchChange:"&",onItemClick:"&",onOpen:"&",onReset:"&",onSelectAll:"&",onSelectNone:"&",translation:"="},templateUrl:"isteven-multi-select.htm",link:function(r,n,l){r.backUp=[],r.varButtonLabel="",r.spacingProperty="",r.indexProperty="",r.orientationH=!1,r.orientationV=!0,r.filteredModel=[],r.inputLabel={labelFilter:""},r.tabIndex=0,r.lang={},r.helperStatus={all:!0,none:!0,reset:!0,filter:!0};var o=0,i=[],a=0,d="",s=[],u=0,p=null;r.clearClicked=function(e){r.inputLabel.labelFilter="",r.updateFilter(),r.select("clear",e)},r.numberToArray=function(e){return new Array(e)},r.searchChanged=function(){if(r.inputLabel.labelFilter.length<u&&r.inputLabel.labelFilter.length>0)return!1;r.updateFilter()},r.updateFilter=function(){r.filteredModel=[];var e=0;if(void 0===r.inputModel)return!1;for(e=r.inputModel.length-1;e>=0;e--){void 0!==r.inputModel[e][l.groupProperty]&&!1===r.inputModel[e][l.groupProperty]&&r.filteredModel.push(r.inputModel[e]);var n=!1;if(void 0===r.inputModel[e][l.groupProperty]){if(void 0!==l.searchProperty&&""!==l.searchProperty){for(var o in r.inputModel[e])if("boolean"!=typeof r.inputModel[e][o]&&String(r.inputModel[e][o]).toUpperCase().indexOf(r.inputLabel.labelFilter.toUpperCase())>=0&&l.searchProperty.indexOf(o)>-1){n=!0;break}}else for(var o in r.inputModel[e])if("boolean"!=typeof r.inputModel[e][o]&&String(r.inputModel[e][o]).toUpperCase().indexOf(r.inputLabel.labelFilter.toUpperCase())>=0){n=!0;break}!0===n&&r.filteredModel.push(r.inputModel[e])}void 0!==r.inputModel[e][l.groupProperty]&&!0===r.inputModel[e][l.groupProperty]&&(void 0!==r.filteredModel[r.filteredModel.length-1][l.groupProperty]&&!1===r.filteredModel[r.filteredModel.length-1][l.groupProperty]?r.filteredModel.pop():r.filteredModel.push(r.inputModel[e]))}r.filteredModel.reverse(),t(function(){if(r.getFormElements(),r.inputLabel.labelFilter.length>u){var e=[];angular.forEach(r.filteredModel,function(t,n){if(void 0!==t&&void 0===t[l.groupProperty]){var o=angular.copy(t),i=e.push(o);delete e[i-1][r.indexProperty],delete e[i-1][r.spacingProperty]}}),r.onSearchChange({data:{keyword:r.inputLabel.labelFilter,result:e}})}},0)},r.getFormElements=function(){s=[];var e=[],t=[],l=[],o=[];r.helperStatus.all||r.helperStatus.none||r.helperStatus.reset?(e=n.children().children().next().children().children()[0].getElementsByTagName("button"),r.helperStatus.filter&&(t=n.children().children().next().children().children().next()[0].getElementsByTagName("input"),o=n.children().children().next().children().children().next()[0].getElementsByTagName("button"))):r.helperStatus.filter&&(t=n.children().children().next().children().children()[0].getElementsByTagName("input"),o=n.children().children().next().children().children()[0].getElementsByTagName("button")),l=r.helperStatus.all||r.helperStatus.none||r.helperStatus.reset||r.helperStatus.filter?n.children().children().next().children().next()[0].getElementsByTagName("input"):n.children().children().next()[0].getElementsByTagName("input");for(var i=0;i<e.length;i++)s.push(e[i]);for(var i=0;i<t.length;i++)s.push(t[i]);for(var i=0;i<o.length;i++)s.push(o[i]);for(var i=0;i<l.length;i++)s.push(l[i])},r.isGroupMarker=function(e,t){return void 0!==e[l.groupProperty]&&e[l.groupProperty]===t},r.removeGroupEndMarker=function(e){return void 0===e[l.groupProperty]||!1!==e[l.groupProperty]},r.syncItems=function(e,n,i){if(n.preventDefault(),n.stopPropagation(),void 0!==l.disableProperty&&!0===e[l.disableProperty])return!1;if(void 0!==l.isDisabled&&!0===r.isDisabled)return!1;if(void 0!==e[l.groupProperty]&&!1===e[l.groupProperty])return!1;var d=r.filteredModel.indexOf(e);if(void 0!==e[l.groupProperty]&&!0===e[l.groupProperty]){if(void 0!==l.selectionMode&&"SINGLE"===l.selectionMode.toUpperCase())return!1;var s,u,c=0,g=r.filteredModel.length-1,f=[],h=0;for(s=d;s<r.filteredModel.length&&!(0===h&&s>d);s++)if(void 0!==r.filteredModel[s][l.groupProperty]&&!0===r.filteredModel[s][l.groupProperty])0===f.length&&(c=s+1),h+=1;else if(void 0!==r.filteredModel[s][l.groupProperty]&&!1===r.filteredModel[s][l.groupProperty]){if(h-=1,f.length>0&&0===h){var b=!0;for(g=s,u=0;u<f.length;u++)if(void 0!==f[u][r.tickProperty]&&!1===f[u][r.tickProperty]){b=!1;break}if(!0===b)for(u=c;u<=g;u++)void 0===r.filteredModel[u][l.groupProperty]&&(void 0===l.disableProperty?(r.filteredModel[u][r.tickProperty]=!1,y=r.filteredModel[u][r.indexProperty],r.inputModel[y][r.tickProperty]=!1):!0!==r.filteredModel[u][l.disableProperty]&&(r.filteredModel[u][r.tickProperty]=!1,y=r.filteredModel[u][r.indexProperty],r.inputModel[y][r.tickProperty]=!1));else for(u=c;u<=g;u++)void 0===r.filteredModel[u][l.groupProperty]&&(void 0===l.disableProperty?(r.filteredModel[u][r.tickProperty]=!0,y=r.filteredModel[u][r.indexProperty],r.inputModel[y][r.tickProperty]=!0):!0!==r.filteredModel[u][l.disableProperty]&&(r.filteredModel[u][r.tickProperty]=!0,y=r.filteredModel[u][r.indexProperty],r.inputModel[y][r.tickProperty]=!0))}}else f.push(r.filteredModel[s])}else{if(void 0!==l.selectionMode&&"SINGLE"===l.selectionMode.toUpperCase()){for(s=0;s<r.filteredModel.length;s++)r.filteredModel[s][r.tickProperty]=!1;for(s=0;s<r.inputModel.length;s++)r.inputModel[s][r.tickProperty]=!1;r.filteredModel[d][r.tickProperty]=!0}else r.filteredModel[d][r.tickProperty]=!r.filteredModel[d][r.tickProperty];var y=r.filteredModel[d][r.indexProperty];r.inputModel[y][r.tickProperty]=r.filteredModel[d][r.tickProperty]}p=angular.copy(e),null!==p&&t(function(){delete p[r.indexProperty],delete p[r.spacingProperty],r.onItemClick({data:p}),p=null},0),r.refreshOutputModel(),r.refreshButton(),o=r.tabIndex,r.tabIndex=i+a,n.target.focus(),r.removeFocusStyle(o),r.setFocusStyle(r.tabIndex),void 0!==l.selectionMode&&"SINGLE"===l.selectionMode.toUpperCase()&&r.toggleCheckboxes(n)},r.refreshOutputModel=function(){r.outputModel=[];var e=[],t={};void 0!==l.outputProperties?(e=l.outputProperties.split(" "),angular.forEach(r.inputModel,function(n,o){if(void 0!==n&&void 0===n[l.groupProperty]&&!0===n[r.tickProperty]){t={},angular.forEach(n,function(r,n){e.indexOf(n)>-1&&(t[n]=r)});var i=r.outputModel.push(t);delete r.outputModel[i-1][r.indexProperty],delete r.outputModel[i-1][r.spacingProperty]}})):angular.forEach(r.inputModel,function(e,t){if(void 0!==e&&void 0===e[l.groupProperty]&&!0===e[r.tickProperty]){var n=angular.copy(e),o=r.outputModel.push(n);delete r.outputModel[o-1][r.indexProperty],delete r.outputModel[o-1][r.spacingProperty]}})},r.refreshButton=function(){r.varButtonLabel="";var t=0;if(0===r.outputModel.length)r.varButtonLabel=r.lang.nothingSelected;else{var n=r.outputModel.length;void 0!==l.maxLabels&&""!==l.maxLabels&&(n=l.maxLabels),r.outputModel.length>n?r.more=!0:r.more=!1,angular.forEach(r.inputModel,function(e,o){void 0!==e&&!0===e[l.tickProperty]&&(t<n&&(r.varButtonLabel+=(r.varButtonLabel.length>0?'</div>, <div class="buttonLabel">':'<div class="buttonLabel">')+r.writeLabel(e,"buttonLabel")),t++)}),!0===r.more&&(n>0&&(r.varButtonLabel+=", ... "),r.varButtonLabel+="("+r.outputModel.length+")")}r.varButtonLabel=e.trustAsHtml(r.varButtonLabel+'<span class="caret"></span>')},r.itemIsDisabled=function(e){return void 0!==l.disableProperty&&!0===e[l.disableProperty]||!0===r.isDisabled},r.writeLabel=function(t,r){var n=l[r].split(" "),o="";return angular.forEach(n,function(e,r){t[e]&&(o+="&nbsp;"+e.split(".").reduce(function(e,t){return e[t]},t))}),"BUTTONLABEL"===r.toUpperCase()?o:e.trustAsHtml(o)},r.toggleCheckboxes=function(e){var l=n.children()[0];if(angular.element(document).off("click",r.externalClickListener),angular.element(document).off("keydown",r.keyboardListener),angular.element(d).hasClass("show"))angular.element(d).removeClass("show"),angular.element(l).removeClass("buttonClicked"),angular.element(document).off("click",r.externalClickListener),angular.element(document).off("keydown",r.keyboardListener),r.removeFocusStyle(r.tabIndex),void 0!==s[r.tabIndex]&&s[r.tabIndex].blur(),t(function(){r.onClose()},0),n.children().children()[0].focus();else{r.inputLabel.labelFilter="",r.updateFilter(),i=[],a=0,angular.element(d).addClass("show"),angular.element(l).addClass("buttonClicked"),angular.element(document).on("click",r.externalClickListener),angular.element(document).on("keydown",r.keyboardListener),r.getFormElements(),r.tabIndex=0;var o=angular.element(n[0].querySelector(".helperContainer"))[0];if(void 0!==o){for(var u=0;u<o.getElementsByTagName("BUTTON").length;u++)i[u]=o.getElementsByTagName("BUTTON")[u];a=i.length+o.getElementsByTagName("INPUT").length}n[0].querySelector(".inputFilter")?(n[0].querySelector(".inputFilter").focus(),r.tabIndex=r.tabIndex+a-2,angular.element(n).children()[0].blur()):r.isDisabled||(r.tabIndex=r.tabIndex+a,r.inputModel.length>0&&(s[r.tabIndex].focus(),r.setFocusStyle(r.tabIndex),angular.element(n).children()[0].blur())),r.onOpen()}},r.externalClickListener=function(e){for(var l=n.find(e.target.tagName),o=0;o<l.length;o++)if(e.target==l[o])return;angular.element(d.previousSibling).removeClass("buttonClicked"),angular.element(d).removeClass("show"),angular.element(document).off("click",r.externalClickListener),angular.element(document).off("keydown",r.keyboardListener),t(function(){r.onClose()},0),n.children().children()[0].focus()},r.select=function(e,t){var n=i.indexOf(t.target);switch(r.tabIndex=n,e.toUpperCase()){case"ALL":angular.forEach(r.filteredModel,function(e,t){void 0!==e&&!0!==e[l.disableProperty]&&void 0===e[l.groupProperty]&&(e[r.tickProperty]=!0)}),r.refreshOutputModel(),r.refreshButton(),r.onSelectAll();break;case"NONE":angular.forEach(r.filteredModel,function(e,t){void 0!==e&&!0!==e[l.disableProperty]&&void 0===e[l.groupProperty]&&(e[r.tickProperty]=!1)}),r.refreshOutputModel(),r.refreshButton(),r.onSelectNone();break;case"RESET":angular.forEach(r.filteredModel,function(e,t){if(void 0===e[l.groupProperty]&&void 0!==e&&!0!==e[l.disableProperty]){var n=e[r.indexProperty];e[r.tickProperty]=r.backUp[n][r.tickProperty]}}),r.refreshOutputModel(),r.refreshButton(),r.onReset();break;case"CLEAR":r.tabIndex=r.tabIndex+1,r.onClear();break;case"FILTER":r.tabIndex=i.length-1}},r.prepareGrouping=function(){var e=0;angular.forEach(r.filteredModel,function(t,n){t[r.spacingProperty]=e,!0===t[l.groupProperty]?e+=2:!1===t[l.groupProperty]&&(e-=2)})},r.prepareIndex=function(){var e=0;angular.forEach(r.filteredModel,function(t,n){t[r.indexProperty]=e,e++})},r.keyboardListener=function(e){var t=e.keyCode?e.keyCode:e.which,n=!1;if(27===t)e.preventDefault(),e.stopPropagation(),r.toggleCheckboxes(e);else if(40===t||39===t||!e.shiftKey&&9==t)for(n=!0,o=r.tabIndex,r.tabIndex++,r.tabIndex>s.length-1&&(r.tabIndex=0,o=s.length-1);!0===s[r.tabIndex].disabled&&(r.tabIndex++,r.tabIndex>s.length-1&&(r.tabIndex=0),r.tabIndex!==o););else if(38===t||37===t||e.shiftKey&&9==t)for(n=!0,o=r.tabIndex,r.tabIndex--,r.tabIndex<0&&(r.tabIndex=s.length-1,o=0);!0===s[r.tabIndex].disabled&&--r.tabIndex!==o;)r.tabIndex<0&&(r.tabIndex=s.length-1);if(!0===n){e.preventDefault(),s[r.tabIndex].focus();"CHECKBOX"===document.activeElement.type.toUpperCase()?(r.setFocusStyle(r.tabIndex),r.removeFocusStyle(o)):(r.removeFocusStyle(o),r.removeFocusStyle(a),r.removeFocusStyle(s.length-1))}n=!1},r.setFocusStyle=function(e){angular.element(s[e]).parent().parent().parent().addClass("multiSelectFocus")},r.removeFocusStyle=function(e){angular.element(s[e]).parent().parent().parent().removeClass("multiSelectFocus")},r.groupProperty=l.groupProperty,r.tickProperty=l.tickProperty,r.directiveId=l.directiveId;var c=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",r="",n=0;n<e;n++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}(5);if(r.indexProperty="idx_"+c,r.spacingProperty="spc_"+c,void 0!==l.orientation&&("HORIZONTAL"===l.orientation.toUpperCase()?(r.orientationH=!0,r.orientationV=!1):(r.orientationH=!1,r.orientationV=!0)),d=n.children().children().next()[0],void 0!==l.maxHeight){var g=n.children().children().children()[0];angular.element(g).attr("style","height:"+l.maxHeight+"; overflow-y:scroll;")}for(var f in r.helperStatus)r.helperStatus.hasOwnProperty(f)&&void 0!==l.helperElements&&-1===l.helperElements.toUpperCase().indexOf(f.toUpperCase())&&(r.helperStatus[f]=!1);void 0!==l.selectionMode&&"SINGLE"===l.selectionMode.toUpperCase()&&(r.helperStatus.all=!1,r.helperStatus.none=!1),r.icon={},r.icon.selectAll="&#10003;",r.icon.selectNone="&times;",r.icon.reset="&#8630;",r.icon.tickMark="&#10003;",void 0!==l.translation?(r.lang.selectAll=e.trustAsHtml(r.icon.selectAll+"&nbsp;&nbsp;"+r.translation.selectAll),r.lang.selectNone=e.trustAsHtml(r.icon.selectNone+"&nbsp;&nbsp;"+r.translation.selectNone),r.lang.reset=e.trustAsHtml(r.icon.reset+"&nbsp;&nbsp;"+r.translation.reset),r.lang.search=r.translation.search,r.lang.nothingSelected=e.trustAsHtml(r.translation.nothingSelected)):(r.lang.selectAll=e.trustAsHtml(r.icon.selectAll+"&nbsp;&nbsp;Select All"),r.lang.selectNone=e.trustAsHtml(r.icon.selectNone+"&nbsp;&nbsp;Select None"),r.lang.reset=e.trustAsHtml(r.icon.reset+"&nbsp;&nbsp;Reset"),r.lang.search="Search...",r.lang.nothingSelected="None Selected"),r.icon.tickMark=e.trustAsHtml(r.icon.tickMark),void 0!==l.MinSearchLength&&parseInt(l.MinSearchLength)>0&&(u=Math.floor(parseInt(l.MinSearchLength))),r.$watch("inputModel",function(e){e&&(r.refreshOutputModel(),r.refreshButton())},!0),r.$watch("inputModel",function(e){e&&(r.backUp=angular.copy(r.inputModel),r.updateFilter(),r.prepareGrouping(),r.prepareIndex(),r.refreshOutputModel(),r.refreshButton())}),r.$watch("isDisabled",function(e){r.isDisabled=e});var h=function(e){r.$apply(function(){r.scrolled=!1})};angular.element(document).bind("touchstart",h);var b=function(e){r.$apply(function(){r.scrolled=!0})};angular.element(document).bind("touchmove",b),r.$on("$destroy",function(){angular.element(document).unbind("touchstart",h),angular.element(document).unbind("touchmove",b)})}}}]).run(["$templateCache",function(e){e.put("isteven-multi-select.htm",'<span class="multiSelect inlineBlock"><button id="{{directiveId}}" type="button"ng-click="toggleCheckboxes( $event ); refreshSelectedItems(); refreshButton(); prepareGrouping; prepareIndex();"ng-bind-html="varButtonLabel"ng-disabled="disable-button"></button><div class="checkboxLayer"><div class="helperContainer" ng-if="helperStatus.filter || helperStatus.all || helperStatus.none || helperStatus.reset "><div class="line" ng-if="helperStatus.all || helperStatus.none || helperStatus.reset "><button type="button" class="helperButton"ng-disabled="isDisabled"ng-if="helperStatus.all"ng-click="select( \'all\', $event );"ng-bind-html="lang.selectAll"></button><button type="button" class="helperButton"ng-disabled="isDisabled"ng-if="helperStatus.none"ng-click="select( \'none\', $event );"ng-bind-html="lang.selectNone"></button><button type="button" class="helperButton reset"ng-disabled="isDisabled"ng-if="helperStatus.reset"ng-click="select( \'reset\', $event );"ng-bind-html="lang.reset"></button></div><div class="line" style="position:relative" ng-if="helperStatus.filter"><input placeholder="{{lang.search}}" type="text"ng-click="select( \'filter\', $event )" ng-model="inputLabel.labelFilter" ng-change="searchChanged()" class="inputFilter"/><button type="button" class="clearButton" ng-click="clearClicked( $event )" >×</button> </div> </div> <div class="checkBoxContainer"><div ng-repeat="item in filteredModel | filter:removeGroupEndMarker" class="multiSelectItem"ng-class="{selected: item[ tickProperty ], horizontal: orientationH, vertical: orientationV, multiSelectGroup:item[ groupProperty ], disabled:itemIsDisabled( item )}"ng-click="syncItems( item, $event, $index );" ng-mouseleave="removeFocusStyle( tabIndex );"> <div class="acol" ng-if="item[ spacingProperty ] > 0" ng-repeat="i in numberToArray( item[ spacingProperty ] ) track by $index"></div>  <div class="acol"><label><input class="checkbox focusable" type="checkbox" ng-disabled="itemIsDisabled( item )" ng-checked="item[ tickProperty ]" ng-click="syncItems( item, $event, $index )" /><span ng-class="{disabled:itemIsDisabled( item )}" ng-bind-html="writeLabel( item, \'itemLabel\' )"></span></label></div><span class="tickMark" ng-if="item[ groupProperty ] !== true && item[ tickProperty ] === true" ng-bind-html="icon.tickMark"></span></div></div></div></span>')}]);